<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Document</title>
   <!-- å¼•å…¥ @opentiny/fluent-editor -->
  <script type="importmap">
    {
      "imports": {
        "@opentiny/fluent-editor": "https://unpkg.com/@opentiny/fluent-editor@3.18.3/index.es.js"
      }
    }
  </script>
  <!-- å¼•å…¥ @opentiny/fluent-editor æ ·å¼ -->
  <link rel="stylesheet" href="https://unpkg.com/@opentiny/fluent-editor@3.18.3/style.css" />
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    /* #app {
      position: relative;
    } */
    #editor {
      height: 90vh;
      width: 70vw;
      display: inline-block;
    }
    #suggestions-panel {
      height: 90vh;
      width: 28vw;
      position: absolute;
      right: 0px;
      top: 40px;
      border: 1px solid #ccc;
    }
    .suggestion-item {
      padding: 12px;
      border-bottom: 1px solid #eee;
      cursor: pointer;
      transition: background 0.2s;
    }
    .suggestion-item:hover {
      background: #f0f7ff;
    }
    .badge {
      padding: 2px 8px;
      border-radius: 12px;
      font-size: 12px;
    }
    .badge.replace {
      background: #ffebee;
      color: #c62828;
    }
    .badge.insert {
      background: #e3f2fd;
      color: #0d47a1;
    }
    .apply-btn {
      background: #1976d2;
      color: white;
      border: none;
      padding: 4px 12px;
      border-radius: 16px;
      font-size: 12px;
      cursor: pointer;
      margin-top: 8px;
    }
    .apply-btn:hover {
      background: #1565c0;
    }
    #apply-all {
      width: 100%;
      padding: 10px;
      background: #2e7d32;
      color: white;
      border: none;
      border-radius: 20px;
      margin-top: 16px;
      cursor: pointer;
      font-weight: bold;
    }
    #clear-highlight {
      width: 100%;
      margin-top: 8px;
      background: #9e9e9e;
      color: white;
      border: none;
      padding: 10px;
      border-radius: 20px;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <div id="editor"></div>
  <div id="suggestions-panel">
    <h3>âœï¸ ä¿®æ”¹å»ºè®®</h3>
    <div id="suggestions-list"></div>
    <button id="apply-all">âœ… å…¨éƒ¨åº”ç”¨</button>
    <button id="clear-highlight">ğŸ§¹ æ¸…é™¤é«˜äº®</button>
  </div>
  
  <script type="module">
    // å¼•å…¥ @opentiny/fluent-editor
    import FluentEditor from '@opentiny/fluent-editor'
    let content = `<h1 id="é¢˜ç›®æè¿°">é¢˜ç›®æè¿°</h1>
      <p>ç°åœ¨éœ€è¦å¯¹ä¸€ä¸ªæ–‡æ¡£ä¸­çš„å†…å®¹è°ƒç”¨ä¸€ä¸ªåç«¯æ¥å£è½¬æˆ<em>htmlå­—ç¬¦ä¸²</em>å</p>
      <p>å†å°†è¿™ä¸ªhtmlå­—ç¬¦ä¸²ä¼ ç»™aiæ¥å£åï¼Œaiæ¥å£è¾“å‡ºå“ªä¸ªæ®µè½å“ªä¸ªå­—æ®µæœ‰è¿æ³•ã€è¯­æ³•é”™è¯¯ã€æ ¼å¼é”™è¯¯çš„ä¿¡æ¯ï¼Œå‰ç«¯è·å–åˆ°è¿™äº›jsonä¸²åï¼Œä¸åŒç±»å‹æŒ‰ä¸åŒé¢œè‰²æ¸²æŸ“åˆ°å¯Œæ–‡æœ¬ç»„ä»¶ä¸­ï¼Œç‚¹å‡»å¤§æ¨¡å‹ç»™å‡ºçš„ä¿®æ”¹å»ºè®®ï¼Œ</p>
      <p>å¯ä»¥å°†å¤§æ¨¡å‹ä¿®æ”¹å»ºè®®åŒæ­¥åˆ°å¯Œæ–‡æœ¬ä¸­</p>
      <p>1ã€å‰ç«¯å¯¼å…¥çš„æ–‡æœ¬æ˜¯docæˆ–è€…docx</p>
      <p>2ã€å¯¼å…¥åçš„æ–‡æœ¬ç›´æ¥è°ƒç”¨aiæ¥å£ï¼Œæ¥å£å½¢å¼æ˜¯httpè¯·æ±‚</p>
      <p>3ã€aiè¿”å›çš„æ ¼å¼ç±»ä¼¼äºï¼š</p>
      <p>{</p>
      <p>"result": [</p>
      <p>{</p>
      <p>"type": "insert",</p>
      <p>"start_idx": 10,</p>
      <p>"end_idx": 10,</p>
      <p>"start_idx_fix": 10,</p>
      <p>"end_idx_fix": 12,</p>
      <p>"ori_text": null,</p>
      <p>"fix_text": "\u8fdb\u884c",</p>
      <p>"class_name": "æ­£æ–‡"</p>
      <p>},---------åŸæ–‡ä¿¡æ¯</p>
      <p>{</p>
      <p>"type": "replace",</p>
      <p>"start_idx": 81,</p>
      <p>"end_idx": 82,</p>
      <p>"start_idx_fix": 83,</p>
      <p>"end_idx_fix": 84,</p>
      <p>"ori_text": "\u9ad8",</p>
      <p>"fix_text": "\u5347",</p>
      <p>"class_name": "è¿æ³•"----è¿è§„è¿æ³•ç±»å‹</p>
      <p>}----------å¤§æ¨¡å‹ç»™å‡ºçš„ä¿®æ”¹ä¿¡æ¯</p>
      <p>]</p>
      <p>}</p>
      <p>4ã€è¦æ±‚å¯Œæ–‡æœ¬ä¿ç•™åŸºç¡€çš„htmlæ ·å¼(æ ‡é¢˜ã€ä¸€çº§æ ‡é¢˜ã€æ­£æ–‡ç­‰åŸºç¡€æ ‡ç­¾)</p>
      <p>5ã€è¦æ±‚åŒæ­¥å¤§æ¨¡å‹ä¿®æ”¹æ„è§åï¼Œä¸å½±å“åŸå¯Œæ–‡æœ¬ä¸­æ ¼å¼</p>
    `

    // åˆå§‹åŒ– TinyEditor å¯Œæ–‡æœ¬ç¼–è¾‘å™¨
    const editor = new FluentEditor('#editor', {
      theme: 'snow',
    })
    editor.root.innerHTML = content

    function renderSuggestions() {
      const suggestions = mockSuggestions.result;
      console.log(suggestions);
      
      const listEl = document.getElementById('suggestions-list');
      if (!listEl) return;
      listEl.innerHTML = '';

      suggestions.forEach((s, idx) => {
        const item = document.createElement('div');
        item.className = 'suggestion-item';
        item.dataset.index = idx;

        const header = document.createElement('div');
        header.className = 'suggestion-header';
        header.innerHTML = `
          <span class="badge ${s.type}">${s.type === 'replace' ? 'æ›¿æ¢' : 'æ’å…¥'}</span>
          <span style="color: #666; font-size: 12px;">${s.class_name || ''}</span>
        `;

        const content = document.createElement('div');
        content.style.margin = '8px 0';
        if (s.type === 'replace') {
          content.innerHTML = `<span style="color: #c62828; text-decoration: line-through;">${s.ori_text}</span> 
                               â†’ 
                               <span style="color: #2e7d32;">${s.fix_text}</span>`;
        } else {
          content.innerHTML = `æ’å…¥ <strong style="background: #bbdefb; padding: 0 2px;">${s.fix_text}</strong>`;
        }

        const applyBtn = document.createElement('button');
        applyBtn.className = 'apply-btn';
        applyBtn.textContent = 'åº”ç”¨æ­¤æ¡';
        applyBtn.onclick = (e) => {
          e.stopPropagation();
          applySingleSuggestion(s, suggestions);
        };

        // ç‚¹å‡»æ¡ç›®æ—¶ï¼Œåœ¨ç¼–è¾‘å™¨ä¸­é€‰ä¸­å¯¹åº”å†…å®¹
        item.onclick = () => {
          if (s.type === 'replace' && s.highlight_range) {
            editor.setSelection(s.highlight_range.start, s.highlight_range.length);
          } else if (s.type === 'insert' && s.marker_pos !== undefined) {
            editor.setSelection(s.marker_pos, s.marker_length);
          }
          editor.focus();
        };

        item.appendChild(header);
        item.appendChild(content);
        item.appendChild(applyBtn);
        listEl.appendChild(item);
      });

      // å¦‚æœæ²¡æœ‰å»ºè®®ï¼Œæ˜¾ç¤ºæç¤º
      if (suggestions.length === 0) {
        listEl.innerHTML = '<div style="padding: 20px; text-align: center; color: #999;">âœ… æš‚æ— ä¿®æ”¹å»ºè®®</div>';
      }
    }

    // åº”ç”¨å•æ¡å»ºè®®
    function applySingleSuggestion(s, suggestions) {
      let changedIdx = 0; // æœ¬æ¬¡ä¿®æ”¹å¯¹åç»­æ–‡æœ¬çš„å½±å“é•¿åº¦
      if(s.type === 'replace') {
        console.log(content.substring(0, s.start_idx));
        
        content = content.substring(0, s.start_idx) + s.fix_text + content.substring(s.end_idx);
        editor.root.innerHTML = content;
        changedIdx = s.fix_text.length - s.ori_text.length; // è®¡ç®—æœ¬æ¬¡ä¿®æ”¹å¯¹åç»­æ–‡æœ¬çš„å½±å“é•¿åº¦
        
      } else if(s.type === 'insert') {
        content = content.substring(0, s.start_idx) + s.fix_text + content.substring(s.start_idx);
        editor.root.innerHTML = content;
        changedIdx = s.fix_text.length; // æ’å…¥æ–‡æœ¬çš„é•¿åº¦
      }

      // æ­¤æ¡ä¹‹åçš„éœ€è¦æ›´æ–°
      const thisIndex = suggestions.indexOf(s);
      const others = suggestions.filter((_, idx) => idx > thisIndex);

      if(changedIdx !== 0) {
        others.forEach(item => {
          item.start_idx += changedIdx;
          item.end_idx += changedIdx;
        })
      }

      mockSuggestions.result = suggestions.filter(item => item !== s); // ä»å»ºè®®åˆ—è¡¨ä¸­ç§»é™¤å·²åº”ç”¨çš„å»ºè®®
      renderSuggestions();
      highlightSuggestions();
    }

    // åº”ç”¨å…¨éƒ¨å»ºè®®
    function applyAllSuggestions() {
      mockSuggestions.result.forEach(s => {
        applySingleSuggestion(s, mockSuggestions.result);
      })
    }

    function highlightSuggestions() {
      let highlightedContent = content;
      let changedLength = 0; // ç´¯ç§¯çš„é•¿åº¦å˜åŒ–ï¼Œç”¨äºè°ƒæ•´åç»­å»ºè®®çš„ä½ç½®
      mockSuggestions.result.forEach(s => {
        if(s.type === 'replace') {
          const start = s.start_idx + changedLength;
          const end = s.end_idx + changedLength;
          const pre = highlightedContent.substring(0, start); 
          const post = highlightedContent.substring(end);   
          const oriText = highlightedContent.substring(start, end);
          const visualText = `<span style="background: #ffcdd2; text-decoration: underline 2px solid #d32f2f;">${oriText} -> ${s.fix_text}</span>`;
          highlightedContent = pre + visualText + post;
          changedLength += visualText.length - oriText.length;
        } else if(s.type === 'insert') {
          const start = s.start_idx + changedLength;
          const pre = highlightedContent.substring(0, start);
          const visualText = `<span style="background: #bbdefb; padding: 0 2px;">${s.fix_text}</span>`;
          highlightedContent = pre + visualText + highlightedContent.substring(start);
          changedLength += visualText.length;
        }
      })
      editor.root.innerHTML = highlightedContent;
    }

    document.getElementById('apply-all').addEventListener('click', () => {
      applyAllSuggestions();
    });

    document.getElementById('clear-highlight').addEventListener('click', () => {
      mockSuggestions.result.length = 0; // æ¸…ç©ºå»ºè®®åˆ—è¡¨
      renderSuggestions();
      editor.root.innerHTML = content; // æ¢å¤åŸå§‹å†…å®¹ï¼Œå»é™¤é«˜äº®
    });

    let mockSuggestions = {
      result: [
        {
          type: 'replace',
          start_idx: 14,
          end_idx: 16,
          ori_text: 'é¢˜ç›®',
          fix_text: 'é¡¹ç›®',
          class_name: 'è¿æ³•',
        },
        {
          type: 'insert',
          start_idx: 52,
          end_idx: 52,
          ori_text: null,
          fix_text: 'api',
          class_name: 'æ­£æ–‡',
        },
      ],
    };

    setTimeout(() => {
      renderSuggestions();
      highlightSuggestions()
    }, 0);
  </script>
</body>
</html>